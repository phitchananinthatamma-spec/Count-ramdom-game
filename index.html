<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üé≤ Mini Game ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö Multiplayer</title>
<style>
body { background:#000; color:#fff; font-family:Arial,sans-serif; text-align:center; margin:0; padding:0;}
h1 { font-weight:bold; margin:15px 0; font-size:2.2em; }
.question { font-size:26px; font-weight:bold; margin:20px 0; }
.answers { display:flex; flex-direction:column; align-items:center; gap:12px; margin-bottom:20px; }
.answer-btn { background:#222; color:#fff; font-weight:bold; padding:12px 25px; border:2px solid #fff; border-radius:12px; cursor:pointer; width:280px; transition:all 0.2s;}
.answer-btn:hover { background:#444; transform:scale(1.05);}
.players { display:flex; justify-content:center; gap:20px; margin-top:20px; flex-wrap:wrap;}
.player { border:2px solid #fff; border-radius:10px; padding:10px; width:150px; background:#111;}
.timer { font-size:20px; font-weight:bold; margin:10px 0;}
#roomControls { margin:20px auto; max-width:450px; padding:20px; border:2px solid #fff; border-radius:15px; background:#111;}
input, select, button { padding:10px; margin:5px; border-radius:10px; font-size:16px;}
#roomInfo { margin-top:15px; font-weight:bold; font-size:16px;}
.emoji { font-size:1.2em; margin-left:5px;}
#nextBtnDiv { margin:10px; }
</style>
</head>
<body>

<h1>üé≤ Mini Game ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö Multiplayer</h1>

<div id="roomControls">
  <input id="playerName" placeholder="‚ú® ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô" style="width:90%; text-align:center;"><br>
  <label style="font-weight:bold;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á:</label>
  <select id="maxPlayers" style="width:50%; text-align:center;">
    <option value="2">2 ‡∏Ñ‡∏ô</option>
    <option value="3">3 ‡∏Ñ‡∏ô</option>
    <option value="4">4 ‡∏Ñ‡∏ô</option>
    <option value="5">5 ‡∏Ñ‡∏ô</option>
  </select><br>
  <button onclick="createRoom()" style="width:80%; background:#ff5722; color:#fff; font-weight:bold; padding:12px;">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button><br>
  <input id="roomIdInput" placeholder="üîë ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á"><br>
  <button onclick="joinRoom()" style="width:80%; background:#03a9f4; color:#fff; font-weight:bold; padding:12px;">üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</button>
  <div id="roomInfo"></div>
</div>

<div class="question" id="question">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</div>
<div class="answers" id="answers"></div>
<div id="nextBtnDiv"></div>
<div class="timer" id="timer">‡πÄ‡∏ß‡∏•‡∏≤: 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚è∞</div>
<div class="players" id="players"></div>
<div id="restartBtnDiv" style="margin:20px;"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

// ---------- Firebase ----------
const firebaseConfig = {
  apiKey: "AIzaSyAScwLSlNF1i0cAAT-xadJTFOgGUEsIilk",
  authDomain: "count-raid-game.firebaseapp.com",
  databaseURL: "https://count-raid-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "count-raid-game",
  storageBucket: "count-raid-game.appspot.com",
  messagingSenderId: "887793946867",
  appId: "1:887793946867:web:14c0c60399fcefc8612786"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---------- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ----------
let roomId="", playerName="", timeLeft=30, timerInterval, currentQuestionIndex=0;
let shuffledQuestions = []; // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°

// ---------- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° + ‡∏Å‡∏¥‡∏°‡∏°‡∏¥‡∏Ñ ----------
const questions=[
  {q:"‡∏°‡∏µ‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ 3 ‡∏ï‡∏±‡∏ß A,B,C ‡∏Å‡∏µ‡πà‡∏ß‡∏¥‡∏ò‡∏µ?", a:["3","6","9","12"], correct:1, bonus:5},
  {q:"‡∏ñ‡πâ‡∏≤‡πÇ‡∏¢‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 2 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç ‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏µ‡πà‡πÅ‡∏ö‡∏ö?", a:["2","3","4","5"], correct:2, bonus:3},
  {q:"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å 1,2,3,4 ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏ä‡∏∏‡∏î‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏Å‡∏µ‡πà‡∏ä‡∏∏‡∏î?", a:["4","6","8","12"], correct:1, bonus:4},
  {q:"‡∏°‡∏µ‡πÄ‡∏•‡∏Ç 1,2,3 ‡∏à‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡∏ß‡∏¥‡∏ò‡∏µ?", a:["3","4","6","9"], correct:2, bonus:2},
  {q:"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å 1,2,3,4,5 ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏ä‡∏∏‡∏î‡∏Å‡∏µ‡πà‡∏ä‡∏∏‡∏î?", a:["10","8","6","5"], correct:0, bonus:6},
  {q:"‡∏ñ‡πâ‡∏≤‡πÇ‡∏¢‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 3 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏µ‡πà‡πÅ‡∏ö‡∏ö?", a:["6","7","8","9"], correct:2, bonus:5}
];

// ---------- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ----------
function shuffleQuestions(arr) {
  const newArr = arr.slice();
  for (let i = newArr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
  }
  return newArr;
}

// ---------- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á 4 ‡∏ï‡∏±‡∏ß ----------
function generateRoomCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  let code = '';
  for(let i=0;i<4;i++) code += chars.charAt(Math.floor(Math.random()*chars.length));
  return code;
}

// ---------- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á ----------
function createRoom(){
  playerName = document.getElementById('playerName').value.trim();
  if(!playerName){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô!"); return; }
  const maxPlayers=parseInt(document.getElementById('maxPlayers').value);

  roomId = generateRoomCode();
  const roomRef = ref(db,'rooms/'+roomId);

  set(roomRef,{
    host:playerName,
    maxPlayers:maxPlayers,
    status:"waiting",
    questionIndex:0,
    players:{ [playerName]:{score:0} }
  }).then(()=>{
    document.getElementById('roomInfo').innerHTML=`
      üéâ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>
      üîë ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: <strong id="roomCode">${roomId}</strong>
      <button onclick="copyRoomCode()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
    `;
    shuffledQuestions = shuffleQuestions(questions); // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    listenRoom();
  }).catch(err=>alert(err.message));
}

// ---------- ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á ----------
function copyRoomCode(){
  const code=document.getElementById('roomCode').innerText;
  navigator.clipboard.writeText(code).then(()=>alert(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: ${code}`));
}

// ---------- ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á ----------
function joinRoom(){
  playerName=document.getElementById('playerName').value.trim();
  roomId=document.getElementById('roomIdInput').value.trim();
  if(!playerName||!roomId){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á!"); return; }

  const playerRef=ref(db,`rooms/${roomId}/players/${playerName}`);
  set(playerRef,{score:0}).then(()=>{
    document.getElementById('roomInfo').innerHTML=`üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: <strong>${roomId}</strong>`;
    shuffledQuestions = shuffleQuestions(questions); // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    listenRoom();
  }).catch(err=>alert(err.message));
}

// ---------- ‡∏ü‡∏±‡∏á‡∏´‡πâ‡∏≠‡∏á ----------
function listenRoom(){
  const roomRef=ref(db,`rooms/${roomId}`);
  onValue(roomRef, snapshot=>{
    const roomData=snapshot.val();
    if(!roomData) return;
    updatePlayers(roomData.players);
    currentQuestionIndex=roomData.questionIndex||0;
    if(roomData.status==="waiting" && Object.keys(roomData.players).length===roomData.maxPlayers)
      set(ref(db,`rooms/${roomId}/status`),"playing");
    if(roomData.status==="playing") showQuestion();
  });
}

// ---------- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ----------
function updatePlayers(playersObj){
  const playersDiv=document.getElementById('players');
  playersDiv.innerHTML="";
  for(const name in playersObj){
    const div=document.createElement('div');
    div.className="player";
    div.innerHTML=`<strong>${name}</strong> <span class="emoji">‚≠ê</span><br>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${playersObj[name].score}`;
    playersDiv.appendChild(div);
  }
}

// ---------- ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠ ----------
function showQuestion(){
  if(currentQuestionIndex>=shuffledQuestions.length) return;
  clearInterval(timerInterval); timeLeft=30;

  const q = shuffledQuestions[currentQuestionIndex]; // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡πà‡∏°
  document.getElementById('question').innerText=`‚ùì ${q.q}`;
  const answersDiv=document.getElementById('answers'); 
  answersDiv.innerHTML="";
  q.a.forEach((ans,index)=>{
    const btn=document.createElement('button');
    btn.className="answer-btn"; 
    btn.innerText=ans; 
    btn.onclick=()=>selectAnswer(index);
    answersDiv.appendChild(btn);
  });

  document.getElementById('nextBtnDiv').innerHTML=""; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô

  timerInterval=setInterval(()=>{
    timeLeft--;
    document.getElementById('timer').innerText=`‡πÄ‡∏ß‡∏•‡∏≤: ${timeLeft} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚è∞`;
    if(timeLeft<=0){ 
      clearInterval(timerInterval); 
      alert(`‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤! ‡πÄ‡∏â‡∏•‡∏¢‡∏Ñ‡∏∑‡∏≠: ${q.a[q.correct]} ‚úÖ`);
      showNextButton(); 
    }
  },1000);
}

// ---------- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ ----------
function showNextButton(){
  document.getElementById('nextBtnDiv').innerHTML=
    `<button onclick="nextQuestion()" style="background:#4caf50;color:#fff;font-weight:bold;padding:12px;border-radius:10px;">‚û°Ô∏è ‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>`;
}

// ---------- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ----------
function selectAnswer(index){
  clearInterval(timerInterval);
  const q=shuffledQuestions[currentQuestionIndex];
  const playerRef=ref(db,`rooms/${roomId}/players/${playerName}/score`);
  get(playerRef).then(snap=>{
    let score=snap.val()||0;
    if(index===q.correct){ score+=10+q.bonus; alert(`‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! üéâ ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ${q.bonus}`); }
    else { score-=5; alert("‡∏ú‡∏¥‡∏î! ‚ùå ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -5"); }
    set(playerRef,score);

    // ‡πÅ‡∏¢‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
    const playersRef=ref(db,`rooms/${roomId}/players`);
    get(playersRef).then(psnap=>{
      const playersData=psnap.val();
      const others=Object.keys(playersData).filter(p=>p!==playerName);
      if(others.length>0){
        const steal=others[Math.floor(Math.random()*others.length)];
        const stealRef=ref(db,`rooms/${roomId}/players/${steal}/score`);
        get(stealRef).then(ssnap=>{
          let sScore=ssnap.val()||0; sScore=Math.max(0,sScore-3);
          set(stealRef,sScore); set(playerRef,score+3);
          alert(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏¢‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ${steal} ‡πÑ‡∏î‡πâ 3 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô üí∞`);
          showNextButton();
        });
      } else showNextButton();
    });
  });
}

// ---------- ‡∏ï‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ----------
function nextQuestion(){
  currentQuestionIndex++;
  set(ref(db,`rooms/${roomId}/questionIndex`),currentQuestionIndex);
  if(currentQuestionIndex>=shuffledQuestions.length){
    alert("‡∏à‡∏ö‡πÄ‡∏Å‡∏°! üéâ");
    showRestartButton();
  } else showQuestion();
}

// ---------- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà ----------
function restartGame(){
  currentQuestionIndex=0;
  shuffledQuestions = shuffleQuestions(questions); // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
  set(ref(db,`rooms/${roomId}/questionIndex`),0);
  set(ref(db,`rooms/${roomId}/status`),"playing");
  const playersRef=ref(db,`rooms/${roomId}/players`);
  get(playersRef).then(snap=>{
    const playersData=snap.val();
    for(const p in playersData) set(ref(db,`rooms/${roomId}/players/${p}/score`),0);
  });
  document.getElementById('restartBtnDiv').innerHTML="";
  showQuestion();
}

// ---------- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ----------
function showRestartButton(){
  document.getElementById('restartBtnDiv').innerHTML=`<button onclick="restartGame()" style="background:#4caf50;color:#fff;font-weight:bold;padding:12px;border-radius:10px;">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>`;
}

// ---------- ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° HTML ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ----------
window.createRoom=createRoom;
window.joinRoom=joinRoom;
window.copyRoomCode=copyRoomCode;
window.restartGame=restartGame;
</script>
</body>
</html>
